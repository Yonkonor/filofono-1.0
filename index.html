<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violín por Velocidad con Semitonos</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            color: white;
        }

        #gValue {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, #4CAF50, #2E7D32);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            margin: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            border: 4px solid white;
        }

        #toggleButton {
            width: 70px;
            height: 70px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            border-radius: 50%;
            font-size: 24px;
            background: radial-gradient(circle, #2196F3, #0D47A1);
            color: white;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            z-index: 100;
        }

        #toggleButton:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }

        #toggleButton:active {
            transform: scale(0.95);
        }

        .slider-container {
            width: 90%;
            max-width: 500px;
            margin: 30px 0;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .slider-wrapper {
            margin: 30px 0;
            position: relative;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }

        .slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            outline: none;
            position: relative;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: radial-gradient(circle, #FF9800, #F57C00);
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: radial-gradient(circle, #FFB74D, #FF9800);
        }

        .slider-ticks {
            display: flex;
            justify-content: space-between;
            position: absolute;
            width: 100%;
            top: 35px;
            pointer-events: none;
        }

        .tick {
            width: 2px;
            height: 10px;
            background: rgba(255, 255, 255, 0.5);
        }

        .tick.major {
            height: 15px;
            background: white;
        }

        .freq-display {
            display: block;
            text-align: center;
            font-size: 20px;
            margin-top: 15px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 10px;
        }

        .note-name {
            font-size: 22px;
            color: #FFD700;
            font-weight: bold;
            margin-top: 5px;
        }

        h1 {
            text-align: center;
            font-size: 32px;
            margin: 10px 0 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            color: #FFD700;
        }

        .instructions {
            text-align: center;
            max-width: 500px;
            margin: 10px 0 30px;
            font-size: 16px;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
        }

        .highlight {
            color: #FFD700;
            font-weight: bold;
        }
    </style>
    <script>
        let audioContext;
        let oscillators = [];
        let isPlaying = false;
        let filteredVelocity = { x: 0, y: 0, z: 0 };
        let lastUpdateTime = 0;
        const velocityDecay = 0.97;
        let startTime;
        
        // Frecuencias base (Re, La, Mi)
        const baseFrequencies = [293.7, 440, 659];
        // Nombres de notas base
        const baseNoteNames = ["Re", "La", "Mi"];
        // Ajuste de semitonos para cada oscilador (-12 a +12)
        let semitones = [0, 0, 0];
        // Nombres de las notas
        const noteNames = ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];

        const toggleButton = document.getElementById('toggleButton');
        const gValueDisplay = document.getElementById('gValue');

        function calculateVelocityMagnitude() {
            return Math.hypot(
                filteredVelocity.x,
                filteredVelocity.y,
                filteredVelocity.z
            );
        }

        function getAdjustedFrequency(index) {
            // Calcular frecuencia ajustada: f * 2^(n/12)
            return baseFrequencies[index] * Math.pow(2, semitones[index] / 12);
        }

        function getNoteName(index) {
            const baseNoteIndex = baseNoteNames[index];
            let noteIndex = 0;
            
            // Encontrar el índice de la nota base
            if (baseNoteNames[index] === "Re") noteIndex = 2;
            else if (baseNoteNames[index] === "La") noteIndex = 9;
            else if (baseNoteNames[index] === "Mi") noteIndex = 4;
            
            // Calcular nueva nota con ajuste de semitonos
            let newIndex = noteIndex + semitones[index];
            
            // Manejar desbordamiento
            while (newIndex < 0) newIndex += 12;
            newIndex = newIndex % 12;
            
            return noteNames[newIndex];
        }

        function createViolinSound() {
            oscillators = baseFrequencies.map((baseFreq, index) => {
                const osc = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // Usar frecuencia ajustada
                const freq = getAdjustedFrequency(index);
                osc.type = 'sawtooth';
                osc.frequency.value = freq;
                gainNode.gain.value = 0;
                
                osc.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                return { osc, gainNode, baseIndex: index };
            });

            oscillators.forEach(obj => obj.osc.start());
        }

        function updateSound(timestamp) {
            const totalVelocity = calculateVelocityMagnitude();
            const silenceThreshold = 0.3;
            
            if (totalVelocity < silenceThreshold) {
                oscillators.forEach(obj => {
                    obj.gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
                });
                gValueDisplay.textContent = '0.00 m/s';
                return;
            }

            const now = audioContext.currentTime;
            const intensityScale = 0.4;
            const intensities = [
                Math.min(Math.pow(Math.abs(filteredVelocity.x * intensityScale), 1.3), 1.5),
                Math.min(Math.pow(Math.abs(filteredVelocity.y * intensityScale), 1.3), 1.5),
                Math.min(Math.pow(Math.abs(filteredVelocity.z * intensityScale), 1.3), 1.5)
            ];

            oscillators.forEach((obj, i) => {
                obj.gainNode.gain.setTargetAtTime(intensities[i] * 0.3, now, 0.1);
                
                const vibratoFreq = 6 + (intensities[i] * 4);
                const vibratoDepth = intensities[i] * 8;
                
                // Actualizar frecuencia con ajuste de semitonos
                const adjustedFreq = getAdjustedFrequency(obj.baseIndex);
                obj.osc.frequency.setValueAtTime(
                    adjustedFreq + Math.sin(now * vibratoFreq * Math.PI * 2) * vibratoDepth,
                    now
                );
            });

            gValueDisplay.textContent = `${totalVelocity.toFixed(2)} m/s`;
        }

        function updateFrequencyDisplay(index) {
            const freqDisplay = document.getElementById(`freq${index+1}`);
            const noteDisplay = document.getElementById(`note${index+1}`);
            const freq = getAdjustedFrequency(index);
            const noteName = getNoteName(index);
            
            freqDisplay.textContent = `${freq.toFixed(1)} Hz`;
            noteDisplay.textContent = `${noteName} (${semitones[index] > 0 ? '+' : ''}${semitones[index]})`;
        }

        function setupSliders() {
            for (let i = 0; i < 3; i++) {
                const slider = document.getElementById(`slider${i+1}`);
                
                slider.addEventListener('input', function() {
                    // Convertir valor (0-24) a semitonos (-12 a 12)
                    semitones[i] = parseInt(this.value) - 12;
                    updateFrequencyDisplay(i);
