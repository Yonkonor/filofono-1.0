<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (mantenemos el mismo estilo) ... -->
</head>
<body>
    <!-- ... (elementos HTML anteriores iguales) ... -->

    <script>
        let audioContext;
        let oscillators = [];
        let isPlaying = false;
        let filteredAccel = { x: 0, y: 0, z: 0 };
        const alpha = 0.2;
        let startTime;
        let lastUpdate = 0;
        const updateInterval = 50;

        const toggleButton = document.getElementById('toggleButton');
        const gValueDisplay = document.getElementById('gValue');
        const frequencies = [293.7, 440, 659];  // Nuevas frecuencias

        // ... (configuración del chart igual) ...

        function calculateGValue() {
            return Math.hypot(filteredAccel.x, filteredAccel.y, filteredAccel.z) / 9.81;
        }

        function createViolinSound() {
            oscillators = frequencies.map((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.value = freq;
                gain.gain.value = 0;
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                return { osc, gain };
            });

            oscillators.forEach(obj => obj.osc.start());
        }

        function updateSound(timestamp) {
            const totalG = calculateGValue();
            const silenceThreshold = 0.1;
            
            if (totalG < silenceThreshold) {
                oscillators.forEach(obj => {
                    obj.gain.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
                });
                gValueDisplay.textContent = '0.00 g';
                updateChart(0, (timestamp - startTime) / 1000);
                return;
            }

            const now = audioContext.currentTime;
            const intensities = [
                Math.min(Math.pow(Math.abs(filteredAccel.x / 9.81), 1.5),  // Intensidad X
                Math.min(Math.pow(Math.abs(filteredAccel.y / 9.81), 1.5),  // Intensidad Y
                Math.min(Math.pow(Math.abs(filteredAccel.z / 9.81), 1.5)   // Intensidad Z
            ];

            oscillators.forEach((obj, i) => {
                obj.gain.gain.setTargetAtTime(intensities[i] * 0.3, now, 0.1);
                
                // Vibrato individual para cada oscilador
                const vibratoFreq = 8;
                const vibratoDepth = intensities[i] * 5;
                obj.osc.frequency.setValueAtTime(
                    frequencies[i] + Math.sin(now * vibratoFreq * Math.PI * 2) * vibratoDepth,
                    now
                );
            });

            if (timestamp - lastUpdate >= updateInterval) {
                updateChart(totalG, (timestamp - startTime) / 1000);
                lastUpdate = timestamp;
            }
        }

        // ... (resto del código igual hasta toggleSound) ...

        async function toggleSound() {
            if (!isPlaying) {
                try {
                    // ... (código de permisos igual) ...

                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    startTime = Date.now();
                    lastUpdate = startTime;
                    createViolinSound();
                    
                    filteredAccel = { x: 0, y: 0, z: 0 };
                    
                    window.addEventListener('devicemotion', (e) => {
                        filteredAccel.x = alpha * e.acceleration.x + (1 - alpha) * filteredAccel.x;
                        filteredAccel.y = alpha * e.acceleration.y + (1 - alpha) * filteredAccel.y;
                        filteredAccel.z = alpha * e.acceleration.z + (1 - alpha) * filteredAccel.z;
                        
                        updateSound(Date.now());
                    });

                    // ... (configuración del chart igual) ...

                } catch (error) {
                    alert('Error: ' + error.message);
                }
            } else {
                oscillators.forEach(obj => obj.osc.stop());
                audioContext.close();
                toggleButton.textContent = '▶';
                toggleButton.style.backgroundColor = '#2196F3';
                isPlaying = false;
                gValueDisplay.textContent = '0.00 g';
            }
        }

        toggleButton.addEventListener('click', toggleSound);
    </script>
</body>
</html>
