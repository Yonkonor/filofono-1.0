<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Viola Virtual - Sonido Suave</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a6c5c, #1f8fb2, #1a6c5c);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .sound-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9rem;
            max-width: 500px;
        }
        
        .sound-info .highlight {
            color: #FFD700;
            font-weight: bold;
        }
        
        .sliders-container {
            width: 100%;
            max-width: 500px;
            margin: auto;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .slider-wrapper {
            margin: 25px 0;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .osc-label {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .osc-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, #2196F3, #0D47A1);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            opacity: 0.7;
        }
        
        .osc-toggle.active {
            background: radial-gradient(circle, #4CAF50, #2E7D32);
        }
        
        .note-display {
            font-size: 1.3rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 15px;
            border-radius: 10px;
            min-width: 120px;
            text-align: center;
            color: #FFD700;
            font-weight: bold;
        }
        
        .slider-container {
            position: relative;
            height: 50px;
            margin: 10px 0 15px;
        }
        
        .slider {
            width: 100%;
            height: 20px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            outline: none;
            position: absolute;
            top: 15px;
            z-index: 2;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, #FF9800, #F57C00);
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
            opacity: 0.7;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: radial-gradient(circle, #FFB74D, #FF9800);
        }
        
        .slider-ticks {
            display: flex;
            justify-content: space-between;
            position: absolute;
            width: 100%;
            top: 0;
            height: 50px;
            pointer-events: none;
        }
        
        .tick {
            width: 2px;
            height: 10px;
            background: rgba(255, 255, 255, 0.5);
            position: relative;
            top: 5px;
        }
        
        .tick.major {
            height: 20px;
            background: white;
        }
        
        .tick.center {
            height: 30px;
            background: #FFD700;
            width: 3px;
        }
        
        .freq-display {
            text-align: center;
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.25);
            padding: 8px;
            border-radius: 10px;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
        }
        
        #toggleButton {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 24px;
            background: radial-gradient(circle, #2196F3, #0D47A1);
            color: white;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.7;
        }
        
        #toggleButton:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        
        #toggleButton:active {
            transform: scale(0.95);
        }
        
        #toggleButton.playing {
            background: radial-gradient(circle, #f44336, #B71C1C);
        }
        
        .orientation-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.5rem;
        }
        
        .orientation-warning i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #FFD700;
        }
        
        @media (max-width: 500px) {
            .sliders-container {
                padding: 20px 15px;
            }
            
            .osc-label {
                font-size: 1.1rem;
            }
            
            .note-display {
                font-size: 1.1rem;
                min-width: 100px;
            }
            
            .osc-toggle {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .sound-info {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }
        
        /* Mensaje de orientación en modo paisaje */
        @media screen and (orientation: landscape) {
            .orientation-warning {
                display: flex;
            }
            
            /* Forzar orientación vertical */
            body {
                transform: rotate(0deg);
            }
        }
    </style>
</head>
<body>
    <div class="sound-info">
        <p>Versión suavizada: <span class="highlight">Sonido más natural de viola</span><br>
        Usa ondas senoidales con filtros y envolvente ADSR</p>
    </div>
    
    <div class="sliders-container">
        <!-- Oscilador 1: Sol -->
        <div class="slider-wrapper">
            <div class="slider-header">
                <div class="osc-label">
                    <button class="osc-toggle" data-index="0">1</button>
                    Sol
                </div>
                <div class="note-display" id="note1">Sol</div>
            </div>
            <div class="slider-container">
                <input type="range" min="0" max="12" value="6" class="slider" id="slider1">
                <div class="slider-ticks" id="ticks1"></div>
            </div>
            <div class="freq-display" id="freq1">196.0 Hz</div>
        </div>
        
        <!-- Oscilador 2: Re -->
        <div class="slider-wrapper">
            <div class="slider-header">
                <div class="osc-label">
                    <button class="osc-toggle" data-index="1">2</button>
                    Re
                </div>
                <div class="note-display" id="note2">Re</div>
            </div>
            <div class="slider-container">
                <input type="range" min="0" max="12" value="6" class="slider" id="slider2">
                <div class="slider-ticks" id="ticks2"></div>
            </div>
            <div class="freq-display" id="freq2">293.7 Hz</div>
        </div>
        
        <!-- Oscilador 3: La -->
        <div class="slider-wrapper">
            <div class="slider-header">
                <div class="osc-label">
                    <button class="osc-toggle active" data-index="2">3</button>
                    La
                </div>
                <div class="note-display" id="note3">La</div>
            </div>
            <div class="slider-container">
                <input type="range" min="0" max="12" value="6" class="slider" id="slider3">
                <div class="slider-ticks" id="ticks3"></div>
            </div>
            <div class="freq-display" id="freq3">440.0 Hz</div>
        </div>
    </div>
    
    <div class="controls">
        <button id="toggleButton">▶</button>
    </div>
    
    <div class="orientation-warning">
        <i>↻</i>
        <h3>Por favor gira tu teléfono</h3>
        <p>Esta aplicación solo funciona en modo vertical</p>
    </div>

    <script>
        // Variables globales
        let audioContext;
        let oscillators = [];
        let isPlaying = false;
        let filteredVelocity = { x: 0, y: 0, z: 0 };
        let lastUpdateTime = 0;
        const velocityDecay = 0.97;
        let startTime;
        let animationFrameId;
        
        // Frecuencias base para viola (Sol, Re, La)
        const baseFrequencies = [196.0, 293.7, 440.0];
        // Ajuste de semitonos para cada oscilador (-6 a +6)
        let semitones = [0, 0, 0];
        // Nombres de las notas
        const noteNames = ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];
        // Estado de los osciladores (activados/desactivados)
        let oscActive = [true, true, true];
        
        // Elementos del DOM
        const toggleButton = document.getElementById('toggleButton');

        // Obtener frecuencia ajustada por semitonos
        function getAdjustedFrequency(index) {
            return baseFrequencies[index] * Math.pow(2, semitones[index] / 12);
        }

        // Obtener nombre de la nota actual
        function getNoteName(index) {
            // Índices base para cada cuerda de viola
            const baseIndices = {
                0: 7,  // Sol
                1: 2,  // Re
                2: 9   // La
            };
            
            let newIndex = baseIndices[index] + semitones[index];
            
            // Manejar desbordamiento
            while (newIndex < 0) newIndex += 12;
            newIndex = newIndex % 12;
            
            return noteNames[newIndex];
        }

        // Crear sonido de viola con envolvente ADSR y filtros
        function createViolinSound() {
            // Crear filtro global para suavizar el sonido
            const globalFilter = audioContext.createBiquadFilter();
            globalFilter.type = 'lowpass';
            globalFilter.frequency.value = 4000; // Frecuencia de corte
            globalFilter.Q.value = 0.7; // Factor de calidad
            globalFilter.connect(audioContext.destination);
            
            oscillators = baseFrequencies.map((baseFreq, index) => {
                const osc = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                // Usar frecuencia ajustada
                const freq = getAdjustedFrequency(index);
                
                // Usar onda senoidal para un sonido más suave
                osc.type = 'sine';
                osc.frequency.value = freq;
                
                // Configurar ganancia inicial
                gainNode.gain.value = 0;
                
                // Configurar filtro para cada oscilador
                filter.type = 'lowpass';
                filter.frequency.value = 3000 + (index * 500); // Frecuencia de corte variable
                filter.Q.value = 0.8;
                
                // Conectar componentes: osc → gain → filter → globalFilter → destino
                osc.connect(gainNode);
                gainNode.connect(filter);
                filter.connect(globalFilter);
                
                return { 
                    osc, 
                    gainNode, 
                    filter,
                    baseIndex: index, 
                    active: oscActive[index],
                    lastGainValue: 0
                };
            });

            // Iniciar osciladores
            oscillators.forEach(obj => obj.osc.start());
        }

        // Actualizar sonido basado en el movimiento con transiciones suaves
        function updateSound(timestamp) {
            const totalVelocity = Math.hypot(
                filteredVelocity.x,
                filteredVelocity.y,
                filteredVelocity.z
            );
            
            const silenceThreshold = 0.2;
            const now = audioContext.currentTime;
            
            // Calcular intensidad suavizada
            const intensityScale = 0.3;
            const intensities = [
                Math.min(Math.pow(Math.abs(filteredVelocity.x * intensityScale), 1.0), 
                Math.min(Math.pow(Math.abs(filteredVelocity.y * intensityScale), 1.0), 
                Math.min(Math.pow(Math.abs(filteredVelocity.z * intensityScale), 1.0)
            ];
            
            // Aplicar efectos a cada oscilador
            oscillators.forEach((obj, i) => {
                if (!obj.active) return;
                
                // Calcular nueva ganancia con suavizado
                const targetGain = intensities[i] * 0.2;
                const gainDiff = targetGain - obj.lastGainValue;
                const newGain = obj.lastGainValue + (gainDiff * 0.1); // Factor de suavizado
                
                // Aplicar envolvente ADSR simplificada
                if (targetGain > 0.01) {
                    // Attack: 10ms, Decay: 50ms, Sustain: 80%
                    obj.gainNode.gain.cancelScheduledValues(now);
                    obj.gainNode.gain.setValueAtTime(obj.lastGainValue, now);
                    obj.gainNode.gain.linearRampToValueAtTime(targetGain, now + 0.01);
                    obj.gainNode.gain.linearRampToValueAtTime(targetGain * 0.8, now + 0.06);
                } else {
                    // Release: 100ms
                    obj.gainNode.gain.cancelScheduledValues(now);
                    obj.gainNode.gain.setValueAtTime(obj.lastGainValue, now);
                    obj.gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                }
                
                obj.lastGainValue = newGain;
                
                // Añadir vibrato sutil
                const vibratoFreq = 5 + (intensities[i] * 2); // Menor frecuencia
                const vibratoDepth = intensities[i] * 2; // Menor profundidad
                
                // Actualizar frecuencia con ajuste de semitonos
                const adjustedFreq = getAdjustedFrequency(obj.baseIndex);
                
                // Suavizar cambios de frecuencia
                obj.osc.frequency.cancelScheduledValues(now);
                obj.osc.frequency.setValueAtTime(obj.osc.frequency.value, now);
                obj.osc.frequency.linearRampToValueAtTime(
                    adjustedFreq + Math.sin(now * vibratoFreq * Math.PI * 2) * vibratoDepth,
                    now + 0.05
                );
                
                // Ajustar filtro según la intensidad para suavizar más en baja intensidad
                obj.filter.frequency.cancelScheduledValues(now);
                obj.filter.frequency.setValueAtTime(obj.filter.frequency.value, now);
                obj.filter.frequency.linearRampToValueAtTime(
                    2000 + (intensities[i] * 3000), 
                    now + 0.1
                );
            });
            
            // Silenciar si la velocidad es baja
            if (totalVelocity < silenceThreshold) {
                oscillators.forEach(obj => {
                    if (obj.active) {
                        obj.gainNode.gain.cancelScheduledValues(now);
                        obj.gainNode.gain.setValueAtTime(obj.lastGainValue, now);
                        obj.gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                        obj.lastGainValue = 0;
                    }
                });
            }
        }

        // Actualizar la visualización de frecuencias
        function updateFrequencyDisplay(index) {
            const freqDisplay = document.getElementById(`freq${index+1}`);
            const noteDisplay = document.getElementById(`note${index+1}`);
            const freq = getAdjustedFrequency(index);
            const noteName = getNoteName(index);
            
            freqDisplay.textContent = `${freq.toFixed(1)} Hz`;
            noteDisplay.textContent = noteName;
        }

        // Configurar los controles deslizantes
        function setupSliders() {
            for (let i = 0; i < 3; i++) {
                const slider = document.getElementById(`slider${i+1}`);
                const ticksContainer = document.getElementById(`ticks${i+1}`);
                
                // Limpiar ticks anteriores
                ticksContainer.innerHTML = '';
                
                // Crear marcas para el slider (ahora solo 13 ticks: 0-12)
                for (let j = 0; j < 13; j++) {
                    const tick = document.createElement('div');
                    tick.className = 'tick';
                    
                    if (j === 6) {
                        tick.classList.add('center');
                    } else if (j % 2 === 0) {
                        tick.classList.add('major');
                    }
                    
                    ticksContainer.appendChild(tick);
                }
                
                // Evento de cambio para el slider
                slider.addEventListener('input', function() {
                    // Convertir valor (0-12) a semitonos (-6 a 6)
                    semitones[i] = parseInt(this.value) - 6;
                    updateFrequencyDisplay(i);
                    
                    // Actualizar frecuencia en tiempo real si está sonando
                    if (isPlaying && oscillators[i]) {
                        const freq = getAdjustedFrequency(i);
                        oscillators[i].osc.frequency.cancelScheduledValues(audioContext.currentTime);
                        oscillators[i].osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                    }
                });
                
                // Inicializar display
                updateFrequencyDisplay(i);
            }
            
            // Configurar botones de toggle para cada oscilador
            document.querySelectorAll('.osc-toggle').forEach(button => {
                const index = parseInt(button.dataset.index);
                
                button.addEventListener('click', function() {
                    oscActive[index] = !oscActive[index];
                    
                    if (oscActive[index]) {
                        this.classList.add('active');
                    } else {
                        this.classList.remove('active');
                    }
                    
                    // Si estamos reproduciendo, actualizamos el estado del oscilador
                    if (isPlaying && oscillators[index]) {
                        if (!oscActive[index]) {
                            const now = audioContext.currentTime;
                            oscillators[index].gainNode.gain.cancelScheduledValues(now);
                            oscillators[index].gainNode.gain.setValueAtTime(oscillators[index].lastGainValue, now);
                            oscillators[index].gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
                            oscillators[index].lastGainValue = 0;
                        }
                    }
                });
            });
        }

        // Alternar inicio/detención
        async function toggleSound() {
            if (!isPlaying) {
                try {
                    // Solicitar permiso para sensores en iOS
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            return;
                        }
                    }

                    // Iniciar contexto de audio con configuración de baja latencia
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        latencyHint: 'interactive'
                    });
                    startTime = Date.now();
                    
                    // Crear sonido
                    createViolinSound();
                    
                    // Inicializar valores
                    filteredVelocity = { x: 0, y: 0, z: 0 };
                    lastUpdateTime = 0;
                    
                    // Escuchar eventos de movimiento
                    window.addEventListener('devicemotion', handleMotion);
                    
                    // Iniciar bucle de animación para actualización constante
                    startAnimationLoop();
                    
                    // Actualizar UI
                    toggleButton.textContent = '⏹';
                    toggleButton.classList.add('playing');
                    isPlaying = true;
                    
                    // Intentar bloquear orientación
                    lockScreenOrientation();
                } catch (error) {
                    console.error('Error al iniciar: ', error);
                }
            } else {
                // Detener sonido con suavizado
                const now = audioContext.currentTime;
                oscillators.forEach(obj => {
                    obj.gainNode.gain.cancelScheduledValues(now);
                    obj.gainNode.g
